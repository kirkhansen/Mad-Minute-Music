// Vex Flow - Stave Note implementation.
// Mohit Muthanna <mohit@muthanna.com>
//
// Copyright Mohit Muthanna 2010
//
// Requires vex.js.
/** @constructor */Vex.Flow.StaveNote=function(e){arguments.length>0&&this.init(e)};Vex.Flow.StaveNote.prototype=new Vex.Flow.Note;Vex.Flow.StaveNote.superclass=Vex.Flow.Note.prototype;Vex.Flow.StaveNote.constructor=Vex.Flow.StaveNote;Vex.Flow.StaveNote.STEM_UP=1;Vex.Flow.StaveNote.STEM_DOWN=-1;Vex.Flow.StaveNote.prototype.getCategory=function(){return"stavenotes"};Vex.Flow.StaveNote.prototype.init=function(e){var t=Vex.Flow.StaveNote.superclass;t.init.call(this,e.duration);this.keys=e.keys;this.clef=e.clef;this.glyph=Vex.Flow.durationToGlyph(this.duration);if(!this.glyph)throw new Vex.RuntimeError("BadArguments","Invalid duration string (No glyph found): "+this.duration);this.dotted=Vex.Flow.durationIsDotted(this.duration);this.keyProps=[];this.displaced=!1;var n=null;for(var r=0;r<this.keys.length;++r){var i=this.keys[r],s=Vex.Flow.keyProperties(i,this.clef);if(!s)throw new Vex.RuntimeError("BadArguments","Invalid key for note properties: "+i);var o=s.line;if(n==null)n=o;else if(Math.abs(n-o)==.5){this.displaced=!0;s.displaced=!0;this.keyProps.length>0&&(this.keyProps[r-1].displaced=!0)}n=o;this.keyProps.push(s)}this.keyProps.sort(function(e,t){return e.line-t.line});this.modifiers=[];this.render_options={glyph_font_scale:38,stem_height:35,stroke_px:3,stroke_spacing:10,annotation_spacing:5};this.setStemDirection(e.stem_direction);this.calcExtraPx()};Vex.Flow.StaveNote.prototype.getYForTopText=function(e){var t=this.getStemExtents();return Vex.Min(this.stave.getYForTopText(e),t.topY-this.render_options.annotation_spacing*(e+1))};Vex.Flow.StaveNote.prototype.getYForBottomText=function(e){var t=this.getStemExtents();return Vex.Max(this.stave.getYForTopText(e),t.baseY+this.render_options.annotation_spacing*(e+1))};Vex.Flow.StaveNote.prototype.setStave=function(e){var t=Vex.Flow.StaveNote.superclass;t.setStave.call(this,e);var n=[];for(var r=0;r<this.keyProps.length;++r){var i=this.keyProps[r].line;n.push(this.stave.getYForNote(i))}return this.setYs(n)};Vex.Flow.StaveNote.prototype.getKeyProps=function(){return this.keyProps};Vex.Flow.StaveNote.prototype.getStemDirection=function(){return this.stem_direction};Vex.Flow.StaveNote.prototype.getStemX=function(){var e=this.getAbsoluteX()+this.x_shift,t=this.getAbsoluteX()+this.x_shift+this.glyph.head_width,n=this.stem_direction==Vex.Flow.StaveNote.STEM_DOWN?e:t;return n};Vex.Flow.StaveNote.prototype.getStemExtents=function(){if(!this.ys||this.ys.length==0)throw new Vex.RERR("NoYValues","Can't get top stem Y when note has no Y values.");var e=this.ys[0],t=this.ys[0];for(var n=0;n<this.ys.length;++n){var r=this.ys[n]+this.render_options.stem_height*-this.stem_direction;if(this.stem_direction==Vex.Flow.StaveNote.STEM_DOWN){e=e>r?e:r;t=t<this.ys[n]?t:this.ys[n]}else{e=e<r?e:r;t=t>this.ys[n]?t:this.ys[n]}}return{topY:e,baseY:t}};Vex.Flow.StaveNote.prototype.getTieRightX=function(){var e=this.getAbsoluteX();e+=this.glyph.head_width+this.x_shift+this.extraRightPx;this.modifierContext&&(e+=this.modifierContext.getExtraRightPx());return e};Vex.Flow.StaveNote.prototype.getTieLeftX=function(){var e=this.getAbsoluteX();e+=this.x_shift-this.extraLeftPx;return e};Vex.Flow.StaveNote.prototype.getModifierStartXY=function(e,t){if(!this.preFormatted)throw new Vex.RERR("UnformattedNote","Can't call GetModifierStartXY on an unformatted note");if(this.ys.length==0)throw new Vex.RERR("NoYValues","No Y-Values calculated for this note.");var n=0;if(e==Vex.Flow.Modifier.Position.LEFT)n=-2;else if(e==Vex.Flow.Modifier.Position.RIGHT)n=this.glyph.head_width+this.x_shift+2;else if(e==Vex.Flow.Modifier.Position.BELOW||e==Vex.Flow.Modifier.Position.ABOVE)n=this.glyph.head_width/2;return{x:this.getAbsoluteX()+n,y:this.ys[t]}};Vex.Flow.StaveNote.prototype.setStemDirection=function(e){e||(e=Vex.Flow.StaveNote.STEM_UP);if(e!=Vex.Flow.StaveNote.STEM_UP&&e!=Vex.Flow.StaveNote.STEM_DOWN)throw new Vex.RERR("BadArgument","Invalid stem direction: "+e);this.stem_direction=e;this.beam=null;this.setPreFormatted(!1);return this};Vex.Flow.StaveNote.prototype.setBeam=function(e){this.beam=e;return this};Vex.Flow.StaveNote.prototype.addToModifierContext=function(e){this.setModifierContext(e);for(var t=0;t<this.modifiers.length;++t)this.modifierContext.addModifier(this.modifiers[t]);this.modifierContext.addModifier(this);this.setPreFormatted(!1)};Vex.Flow.StaveNote.prototype.addModifier=function(e,t){t.setNote(this);t.setIndex(e);this.modifiers.push(t);this.setPreFormatted(!1);return this};Vex.Flow.StaveNote.prototype.addAccidental=function(e,t){t.setNote(this);t.setIndex(e);this.modifiers.push(t);this.setPreFormatted(!1);return this};Vex.Flow.StaveNote.prototype.addArticulation=function(e,t){t.setNote(this);t.setIndex(e);this.modifiers.push(t);this.setPreFormatted(!1);return this};Vex.Flow.StaveNote.prototype.addAnnotation=function(e,t){t.setNote(this);t.setIndex(e);this.modifiers.push(t);this.setPreFormatted(!1);return this};Vex.Flow.StaveNote.prototype.addDot=function(e){var t=new Vex.Flow.Dot;t.setNote(this);t.setIndex(e);this.modifiers.push(t);this.setPreFormatted(!1);return this};Vex.Flow.StaveNote.prototype.addDotToAll=function(){for(var e=0;e<this.keys.length;++e)this.addDot(e);return this};Vex.Flow.StaveNote.prototype.getAccidentals=function(){return this.modifierContext.getModifiers("accidentals")};Vex.Flow.StaveNote.prototype.getDots=function(){return this.modifierContext.getModifiers("dots")};Vex.Flow.StaveNote.prototype.getVoiceShiftWidth=function(){return this.glyph.head_width*(this.displaced?2:1)};Vex.Flow.StaveNote.prototype.calcExtraPx=function(){this.setExtraLeftPx(this.displaced&&this.stem_direction==-1?this.glyph.head_width:0);this.setExtraRightPx(this.displaced&&this.stem_direction==1?this.glyph.head_width:0)};Vex.Flow.StaveNote.prototype.preFormat=function(){if(this.preFormatted)return;this.modifierContext&&this.modifierContext.preFormat();var e=this.glyph.head_width+this.extraLeftPx+this.extraRightPx;this.glyph.flag&&this.beam==null&&this.stem_direction==1&&(e+=this.glyph.head_width);this.setWidth(e);this.setPreFormatted(!0)};Vex.Flow.StaveNote.prototype.draw=function(){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw without a canvas context.");if(!this.stave)throw new Vex.RERR("NoStave","Can't draw without a stave.");if(this.ys.length==0)throw new Vex.RERR("NoYValues","Can't draw note without Y values.");var e=this.context,t=this.getAbsoluteX()+this.x_shift,n=this.ys,r=this.keys,i=this.glyph,s=this.stem_direction,o=null,u=!0,a=this.beam==null,f=this.beam==null,l=t,c=t+i.head_width,h=null,p=null,d=null,v=!1,m=0,g=r.length,y=1;if(s==Vex.Flow.StaveNote.STEM_DOWN){m=r.length-1;g=-1;y=-1}var b=5,w=1;for(var E=m;E!=g;E+=y){var S=this.keyProps[E],x=S.line;b=x>b?x:b;w=x<w?x:w;if(d==null)d=x;else if(Math.abs(d-x)==.5)v=!v;else{v=!1;o=t}d=x;var T=n[E];if(h==null||T<h)h=T;if(p==null||T>p)p=T;var N=i.code_head,C=l+(v?i.head_width*s:0);if(S.code){N=S.code;C=l+S.shift_right}if(u){Vex.Flow.renderGlyph(e,C,T,this.render_options.glyph_font_scale,N);if(x<=0||x>=6){var k=T,L=Math.floor(x);x<0&&L-x==-.5?k-=5:x>6&&L-x==-.5&&(k+=5);e.fillRect(C-this.render_options.stroke_px,k,C+i.head_width-C+this.render_options.stroke_px*2,1)}}}if(!i.rest){var A=this;function O(t){o!=null&&(C=o);e.fillRect(C-A.render_options.stroke_px,t,C+i.head_width-C+A.render_options.stroke_px*2,1)}for(var x=6;x<=b;++x)O(this.stave.getYForNote(x));for(var x=0;x>=w;--x)O(this.stave.getYForNote(x))}var M=(p-h)*s+this.render_options.stem_height*s;if(i.stem&&a){var _,D;if(s==Vex.Flow.StaveNote.STEM_DOWN){_=l;D=h;if(i.code_head=="v95"||i.code_head=="v3e")D+=4}else{_=c;D=p;if(i.code_head=="v95"||i.code_head=="v3e")D-=4}e.fillRect(_,D-(M<0?0:M),1,Math.abs(M))}if(i.flag&&f){var P,H,B;if(s==Vex.Flow.StaveNote.STEM_DOWN){P=l+1;H=h-M;B=i.code_flag_downstem}else{P=c+1;H=p-M;B=i.code_flag_upstem}Vex.Flow.renderGlyph(e,P,H,this.render_options.glyph_font_scale,B)}for(var E=0;E<this.modifiers.length;++E){var j=this.modifiers[E];j.setContext(this.context);j.draw()}};